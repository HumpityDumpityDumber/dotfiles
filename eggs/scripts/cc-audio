#!/bin/bash

ELGATO_SOURCE="alsa_input.usb-Elgato_Elgato_HD60_X_A00XB422206D8Q-02.analog-stereo"

notify() {
  notify-send "Elgato Audio" "$@"
}

loopback_loaded() {
  pactl list short modules | grep -q "module-loopback.*$ELGATO_SOURCE"
}

if loopback_loaded; then
  echo "Loopback module for Elgato source already loaded. Exiting."
  notify "Loopback module already loaded, nothing to do."
  exit 0
fi

echo "Loading loopback module for Elgato..."
pactl load-module module-loopback source="$ELGATO_SOURCE"

source_id=$(pactl list sources short | awk -v src="$ELGATO_SOURCE" '$2 == src {print $1}')

if [[ -z "$source_id" ]]; then
  echo "Elgato source not found."
  notify "Elgato source not found. Exiting."
  exit 1
fi

pactl list source-outputs | awk -v srcid="$source_id" '
  /^Source Output #/ { so_id = substr($3, 2) }
  /Source:/ { if ($2 == srcid) print so_id }
' | while read -r source_output_id; do
  echo "Setting volume of source output #$source_output_id to 60%"
  pactl set-source-output-volume "$source_output_id" 60%
done

timeout 1 ffplay -autoexit -f video4linux2 /dev/video0 >/dev/null 2>&1

notify "Loopback module loaded and volumes adjusted."
